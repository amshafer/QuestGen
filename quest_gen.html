<!DOCTYPE html>

<html lang="en-us" >
  <meta name="twitter:card" content="Quest Generator"></meta>
  <meta name="twitter:text:title" content="Quest Gen"></meta>
  <meta property="og:title" content="Quest Gen" />
  <meta property="og:description" content="An interactive quest generator" />
  <head>
    <title>Quest Gen</title>
    <meta name="robots" content="ALL">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://badland.io/static/tracery.js" type="text/javascript"></script>
  </head>
  <body onload="setTimeout(() => generate_quest(), 3000)">
    <script type="text/javascript">
      function request_one_gpt2_sent(prompt, num) {
	  var xmlHttp = new XMLHttpRequest();
	  var url = "https://badland.io/quest_gen?num=" + num + " + &sent=" + prompt;
	  var resp = "";
	  xmlHttp.onreadystatechange = function() {
              if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
		  resp = xmlHttp.responseText;
	  }
	  xmlHttp.open("GET", url, false); // true for asynchronous
	  xmlHttp.send(null);
	  return resp;
      }

      function generate_quest() {
	  var reg = document.getElementById("quest_region");

	  var grammar = {}
	  grammar.origin = ["#electrical#", "#administration#"];
	  grammar.electrical = [
	      "The emergency lights are flashing. You need to plug in the wires to turn the alarms off.",
	      "Too much power was being drawn and all the fuses blew. Flip the switches back on.",
	      "Restart the generator to restore power to the ship. Don't take too long, the oxygen won't last forever.",
	  ];
	  grammar.administration = "Swipe the credit card. Hopefully your transaction won't be declined.";
	  console.log("Final grammar is: " + grammar);
	  var trace = tracery.createGrammar(grammar);

	  var quest = trace.flatten("#origin#");
	  var qs = quest.split(".");
	  var fin = "";
	  for (var i = 0; i < qs.length; i++) {
	      qs[i] = qs[i] + ".";
	      var gpt = request_one_gpt2_sent(qs[i], Math.floor(Math.random() * 2) + 1);
	      fin = fin + qs[i] + " " + gpt + " ";
	  }
	  fin += "\n";

	  console.log("Final quest: " + fin);
	  var paragraphs = fin.split("\n");
	  reg.textContent = "";
	  for (var i = 0; i < qs.length; i++) {
	      reg.appendChild(document.createTextNode(paragraphs[i]));
	      reg.appendChild(document.createElement("br"));
	  }
      }

      function post_text(value) {
	  var passage = document.getElementById("passage_region");
	  var newtext = document.createTextNode(value);
	  passage.appendChild(newtext);
	  passage.appendChild(document.createElement("br"));
      }

      function process_usertext() {
	  var usertext = document.getElementById("usertext");
	  post_text(usertext.value);

	  usertext.value = "";
      }
    </script>

    <br>
    <div id="quest_region">waiting for server...</div>
    <br><br><hr><br><br>
    <div id="passage_region"></div>

    <br><hr>
    <div id="input_region">
      <form onsubmit="process_usertext(); return false;">
	<br><br>
	<input type="button" onclick="process_usertext()" value="Enter your action:">
	<input type="text" id="usertext">
	<br><br>
      </form>
    </div>
  </body>
</html>
