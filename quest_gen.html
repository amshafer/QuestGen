<!DOCTYPE html>

<html lang="en-us" >
  <meta name="twitter:card" content="Quest Generator"></meta>
  <meta name="twitter:text:title" content="Quest Gen"></meta>
  <meta property="og:title" content="Quest Gen" />
  <meta property="og:description" content="An interactive quest generator" />
  <head>
    <title>Quest Gen</title>
    <meta name="robots" content="ALL">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://badland.io/static/tracery.js" type="text/javascript"></script>
  </head>
  <body onload="setTimeout(() => generate_quest(), 3000)">
    <script type="text/javascript">
      var grammar = {}
      grammar.origin = ["electrical", "cafeteria", "administration"];
      grammar.cafeteria = ["Wash the dishes."];
      grammar.cafeteria_tasks = ["wash the dishes"];
      grammar.electrical = [
	  "The emergency lights are flashing. You need to plug in the wires to turn the alarms off.",
	  "Too much power was being drawn and all the fuses blew. Flip the switches back on.",
	  "Restart the generator to restore power to the ship. Don't take too long, the oxygen won't last forever.",
      ];
      grammar.electrical_tasks = [
	  "plug in the wires",
	  "flip the switches on",
	  "restart the generator",
      ];
      grammar.administration = ["Swipe the credit card. Hopefully your transaction won't be declined."];
      grammar.administration_tasks = ["swipe the credit card"];
      console.log("Final grammar is: " + grammar);

      var loc = Math.floor(Math.random() * grammar.origin.length);
      var loc_string = grammar.origin[loc];
      var script = Math.floor(Math.random() * grammar[loc_string].length);
      var quest = grammar[loc_string][script];
      var task = grammar[loc_string + "_tasks"][script];
      console.log("User needs to perform: " + task);

      function post_text(value) {
	  var passage = document.getElementById("passage_region");
	  var newtext = document.createTextNode(value);
	  passage.appendChild(newtext);
	  passage.appendChild(document.createElement("br"));
      }

      var cur_loc = "cafeteria";
      function print_available_actions() {
	  post_text("...> Actions available are:");
	  for (var i = 0; i < grammar.origin.length; i++) {
	      post_text("move-to " + grammar.origin[i]);
	  }
	  for (var i = 0; i < grammar[cur_loc].length; i++) {
	      post_text(grammar[cur_loc + "_tasks"][i]);
	  }
      }

      function request_one_gpt2_sent(prompt, num) {
	  var xmlHttp = new XMLHttpRequest();
	  var url = "https://badland.io/quest_gen?num=" + num + " + &sent=" + prompt;
	  var resp = "";
	  xmlHttp.onreadystatechange = function() {
              if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
		  resp = xmlHttp.responseText;
	  }
	  xmlHttp.open("GET", url, false); // true for asynchronous
	  xmlHttp.send(null);
	  return resp;
      }

      function generate_quest() {
	  var reg = document.getElementById("quest_region");

	  var qs = quest.split(".");
	  var fin = "";
	  for (var i = 0; i < qs.length - 1; i++) {
	      qs[i] = qs[i] + ".";
	      var gpt = request_one_gpt2_sent(qs[i], Math.floor(Math.random() * 2) + 1);
	      fin = fin + qs[i] + " " + gpt + " ";
	  }
	  fin += "\n";

	  console.log("Final quest: " + fin);
	  var paragraphs = fin.split("\n");
	  reg.textContent = "";
	  for (var i = 0; i < paragraphs.length; i++) {
	      reg.appendChild(document.createTextNode(paragraphs[i]));
	      reg.appendChild(document.createElement("br"));
	  }
	  print_available_actions();
      }

      var won = false;
      function process_usertext() {
	  if (won) {
	      return false;
	  }

	  var usertext = document.getElementById("usertext");

	  var words = usertext.value.split(" ");
	  var matches = usertext.value.toLowerCase().includes(task.toLowerCase());
	  if (words[0] == "move-to") {
	      post_text(usertext.value);
	      if (grammar.origin.includes(words[1])) {
		  cur_loc = words[1];
		  post_text("...> moved to " + words[1]);
		  print_available_actions();
	      }
	  } else if (matches && cur_loc != loc_string) {
	      post_text(usertext.value);
	      post_text("...> You're not in the right place!");
	  } else if (matches && cur_loc == loc_string) {
	      post_text(usertext.value);
	      post_text("...> You won!");
	      won = true;
	  } else {
	      post_text(usertext.value);
	  }
	  
	  usertext.value = "";
	  return false;
      }
    </script>

    <br>
    <div id="quest_region">waiting for server...</div>
    <br><br><hr><br><br>
    <div id="passage_region"></div>

    <br><hr>
    <div id="input_region">
      <form onsubmit="return process_usertext()">
	<br><br>
	<input type="button" onclick="return process_usertext()" value="Enter your action:">
	<input type="text" id="usertext">
	<br><br>
      </form>
    </div>
  </body>
</html>
